<?php
/**
 * This file is part of prolic/fpp.
 * (c) 2018 Sascha-Oliver Prolic <saschaprolic@googlemail.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

declare(strict_types=1);

namespace Fpp;

const dump = '\Fpp\dump';

function dump(DefinitionCollection $collection, callable $loadTemplate, callable $replace): string
{
    $code = <<<CODE
<?php

// this file is auto-generated by prolic/fpp
// don't edit this file manually

declare(strict_types=1);


CODE;

    foreach ($collection->definitions() as $definition) {
        $constructors = $definition->constructors();

        if (1 === count($constructors)) {
            $constructor = $constructors[0];
            $code .= $replace($loadTemplate($definition, $constructor), $definition, $constructor, $collection);
        } else {
            $createBaseClass = true;

            foreach ($constructors as $constructor) {
                if ($definition->namespace()) {
                    $name = str_replace($definition->namespace() . '\\', '', $constructor->name());
                } else {
                    $name = $constructor->name();
                }

                if ($definition->name() === $name) {
                    $createBaseClass = false;
                }

                $code .= $replace($loadTemplate($definition, $constructor), $definition, $constructor, $collection);
            }

            if ($createBaseClass) {
                $code .= $replace($loadTemplate($definition, null), $definition, null, $collection);
            }
        }
    }

    return substr($code, 0, -1);
}
